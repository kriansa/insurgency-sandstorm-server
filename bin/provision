#!/usr/bin/env bash

# cd to root path
cd "$(dirname "$0")/.." || exit

if [ $# -le 1 ]; then
  echo "You must pass the host and the user parameters!"
  echo "Usage: $0 <host> <user>"
  exit 1
fi

# The first parameter is always the host (or IP)
host=$1
user=$2

# Waits for SSH to become available
while true; do
  nc -zw 1 "$host" 22 && break
  printf '.' 
  sleep 1
done

# Run the playbook
cd ops/ansible && ansible-playbook --inventory="${host}," "server.yml" \
  --user="$user" \
  --ssh-common-args="-o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no"
