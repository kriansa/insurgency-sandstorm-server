#!/usr/bin/env bash

# cd to root path
cd "$(dirname "$0")/.." || exit

if [ $# -le 0 ]; then
  echo "You must pass the host parameter!"
  echo "Usage: $0 <host>"
  exit 1
fi

# The first parameter is always the host (or IP)
host="$1"

# Waits for SSH to become available
while true; do
  nc -zw 1 "$host" 22 && break
  printf '.' 
  sleep 1
done

# Run the playbook
cd ansible && ansible-playbook --inventory="${host}," "server.yml" \
  --ssh-common-args="-o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no"
